import streamlit as st
import pandas as pd
import numpy as np
import altair as alt

# -----------------------------------------------------------------------------
# 1. í˜ì´ì§€ ê¸°ë³¸ ì„¤ì • & CSS ë””ìì¸
# -----------------------------------------------------------------------------
st.set_page_config(
    page_title="ì¬í…Œí¬ í†µí•© ì†”ë£¨ì…˜",
    page_icon="ğŸ’",
    layout="wide"
)

# ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ë””ìì¸ì„ ìœ„í•œ ì»¤ìŠ¤í…€ CSS
st.markdown("""
<style>
    /* ì „ì²´ ë°°ê²½ìƒ‰ */
    .stApp {
        background-color: #f8f9fa;
    }
    /* ì£¼ìš” ì§€í‘œ ì¹´ë“œ ë””ìì¸ */
    div[data-testid="stMetric"] {
        background-color: #ffffff;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        border: 1px solid #e9ecef;
    }
    div[data-testid="stMetricLabel"] {
        font-size: 14px;
        color: #6c757d;
    }
    div[data-testid="stMetricValue"] {
        font-size: 24px;
        font-weight: 700;
        color: #2c3e50;
    }
    /* íƒ­ ë””ìì¸ */
    .stTabs [data-baseweb="tab-list"] {
        gap: 10px;
    }
    .stTabs [data-baseweb="tab"] {
        background-color: #ffffff;
        border-radius: 5px;
        padding: 10px 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .stTabs [aria-selected="true"] {
        background-color: #e3f2fd;
        color: #1976d2;
        font-weight: bold;
    }
    /* ê²½ê³ /ì„±ê³µ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .custom-box {
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    .box-success { background-color: #e8f5e9; border-left: 5px solid #43a047; }
    .box-warning { background-color: #ffebee; border-left: 5px solid #e53935; }
    .box-info { background-color: #e3f2fd; border-left: 5px solid #1e88e5; }
</style>
""", unsafe_allow_html=True)

# í—¤ë” ì„¹ì…˜
st.markdown("### ğŸ’ ë‹¹ì‹ ì˜ ë¯¸ë˜ë¥¼ ì„¤ê³„í•˜ëŠ” **Premium ì¬í…Œí¬ ì‹œë®¬ë ˆì´í„°**")
st.caption("í˜„ì¬ ìì‚°ê³¼ ëª©í‘œë¥¼ ì…ë ¥í•˜ë©´, AI ì•Œê³ ë¦¬ì¦˜ì´ ì€í‡´ í›„ ìì‚° íë¦„ê³¼ ë¶€ë™ì‚° ì „ëµì„ ë¶„ì„í•´ ë“œë¦½ë‹ˆë‹¤.")
st.divider()

# -----------------------------------------------------------------------------
# 2. ì‚¬ì´ë“œë°” (ì…ë ¥ íŒ¨ë„ - ê·¸ë£¹í™”í•˜ì—¬ ê¹”ë”í•˜ê²Œ ì •ë¦¬)
# -----------------------------------------------------------------------------
with st.sidebar:
    st.header("âš™ï¸ ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •")
    
    with st.expander("ğŸ‘¤ ê¸°ë³¸ ì •ë³´ (ë‚˜ì´/ìˆ˜ëª…)", expanded=True):
        col_age1, col_age2 = st.columns(2)
        current_age = col_age1.number_input("í˜„ì¬ ë‚˜ì´", 20, 80, 35)
        retire_age = col_age2.number_input("ì€í‡´ ë‚˜ì´", current_age+1, 90, 60)
        life_expectancy = st.slider("ê¸°ëŒ€ ìˆ˜ëª…", 80, 100, 90)

    with st.expander("ğŸ’° ìì‚° ë° ì €ì¶•", expanded=True):
        current_cash = st.number_input("í˜„ì¬ ìˆœìì‚° (ë§Œì›)", value=5000, step=100, help="ë¶€ì±„ë¥¼ ì œì™¸í•œ ìˆœìˆ˜ ìì‚°")
        monthly_save = st.number_input("ì›” ì €ì¶•ì•¡ (ë§Œì›)", value=200, step=10)
        invest_rate = st.slider("ì—°í‰ê·  ìˆ˜ìµë¥  (%)", 1.0, 15.0, 5.0)

    with st.expander("ğŸ  ë¶€ë™ì‚° ë§¤ìˆ˜ ê³„íš", expanded=True):
        buy_house = st.checkbox("ë‚´ ì§‘ ë§ˆë ¨ ê³„íš ìˆìŒ", value=True)
        if buy_house:
            house_price = st.number_input("ëª©í‘œ ì£¼íƒ ê°€ê²© (ë§Œì›)", value=60000, step=1000)
            buy_age = st.number_input("ë§¤ìˆ˜ ì˜ˆì • ë‚˜ì´", current_age, retire_age, current_age+3)
            loan_ratio = st.slider("ëŒ€ì¶œ ë¹„ì¤‘ (LTV %)", 0, 80, 40)
            loan_rate = st.number_input("ëŒ€ì¶œ ê¸ˆë¦¬ (%)", value=4.0, step=0.1)

    st.markdown("---")
    st.caption("Designed for 1ì¸ ì‚¬ì—…ê°€ Solopreneur")

# -----------------------------------------------------------------------------
# 3. ê³„ì‚° ë¡œì§ (Core Logic)
# -----------------------------------------------------------------------------
ages = []
assets = []
events = []
cash_flow = [] # í˜„ê¸ˆ íë¦„ ê¸°ë¡

money = current_cash
has_house = False
loan_balance = 0
house_value = 0

for age in range(current_age, life_expectancy + 1):
    ages.append(age)
    
    # 1. ìˆ˜ì…/ì§€ì¶œ (ì€í‡´ ì „í›„)
    if age < retire_age:
        annual_save = monthly_save * 12
        money += annual_save
    else:
        annual_spend = 300 * 12 # ì€í‡´ í›„ ì—° 3600ë§Œì› ì§€ì¶œ ê°€ì • (ë‹¨ìˆœí™”)
        money -= annual_spend

    # 2. íˆ¬ì ìˆ˜ìµ (ë³µë¦¬)
    money = money * (1 + invest_rate / 100)

    # 3. ë¶€ë™ì‚° ë§¤ìˆ˜ ì´ë²¤íŠ¸
    if buy_house and age == buy_age and not has_house:
        loan_amount = house_price * (loan_ratio / 100)
        required_cash = house_price - loan_amount
        acquisition_tax = house_price * 0.011 
        
        # ìê¸ˆ ì²´í¬
        if money >= (required_cash + acquisition_tax):
            money -= (required_cash + acquisition_tax)
            loan_balance = loan_amount
            house_value = house_price
            has_house = True
            events.append({"ë‚˜ì´": age, "ì´ë²¤íŠ¸": f"ğŸ  ì•„íŒŒíŠ¸ ë§¤ìˆ˜ ({house_price/10000:.1f}ì–µ)", "ìœ í˜•": "ì„±ê³µ"})
        else:
            events.append({"ë‚˜ì´": age, "ì´ë²¤íŠ¸": "âŒ ìê¸ˆ ë¶€ì¡±ìœ¼ë¡œ ë§¤ìˆ˜ ì‹¤íŒ¨", "ìœ í˜•": "ì‹¤íŒ¨"})

    # 4. ë¶€ë™ì‚° ê´€ë¦¬ (ì´ì ìƒí™˜ ë° ê°€ì¹˜ ìƒìŠ¹)
    if has_house:
        # ì´ì ë‚©ë¶€ (ì›ë¦¬ê¸ˆ ê· ë“± ë“± ë³µì¡í•œ ë¡œì§ ëŒ€ì‹  ì´ìë§Œ ë‚©ë¶€ë¡œ ë‹¨ìˆœí™”í•˜ì—¬ ì‹œë®¬ë ˆì´ì…˜)
        interest_payment = loan_balance * (loan_rate / 100)
        money -= interest_payment
        house_value = house_value * 1.02 # ë§¤ë…„ 2% ìƒìŠ¹ ê°€ì •
    
    # ìˆœìì‚° í•©ê³„
    net_asset = money + (house_value if has_house else 0) - loan_balance
    assets.append(round(net_asset))

# ë°ì´í„°í”„ë ˆì„ ìƒì„±
df_result = pd.DataFrame({'ë‚˜ì´': ages, 'ìì‚°': assets})

# -----------------------------------------------------------------------------
# 4. ê²°ê³¼ í™”ë©´ (Tabs êµ¬ì¡°)
# -----------------------------------------------------------------------------
tab1, tab2, tab3 = st.tabs(["ğŸ“Š ì¢…í•© ëŒ€ì‹œë³´ë“œ", "ğŸ  ë¶€ë™ì‚° ë¶„ì„", "ğŸ“ ìƒì„¸ ë¦¬í¬íŠ¸"])

# [Tab 1] ì¢…í•© ëŒ€ì‹œë³´ë“œ
with tab1:
    # í•µì‹¬ ì§€í‘œ ì¹´ë“œ
    col_m1, col_m2, col_m3 = st.columns(3)
    final_asset = assets[-1]
    retire_asset = assets[retire_age - current_age]
    
    col_m1.metric("ì€í‡´ ì‹œì  ì˜ˆìƒ ìì‚°", f"{retire_asset:,.0f} ë§Œì›", f"{retire_age}ì„¸ ê¸°ì¤€")
    col_m2.metric("90ì„¸ ìµœì¢… ìì‚°", f"{final_asset:,.0f} ë§Œì›", delta="ì—¬ìœ " if final_asset > 0 else "ë¶€ì¡±")
    
    status_msg = "ì•ˆì •ì " if final_asset > 0 else "ìœ„í—˜"
    col_m3.metric("ì¬ë¬´ ìƒíƒœ ì§„ë‹¨", status_msg)

    # ë©”ì¸ ê·¸ë˜í”„ (Altair Chartë¡œ ì—…ê·¸ë ˆì´ë“œ - íˆ´íŒ ê¸°ëŠ¥ ì¶”ê°€)
    st.subheader("ğŸ“ˆ ìƒì•  ìì‚° íë¦„ë„")
    
    chart = alt.Chart(df_result).mark_area(
        line={'color':'#1f77b4'},
        color=alt.Gradient(
            gradient='linear',
            stops=[alt.GradientStop(color='white', offset=0),
                   alt.GradientStop(color='#1f77b4', offset=1)],
            x1=1, x2=1, y1=1, y2=0
        )
    ).encode(
        x=alt.X('ë‚˜ì´', title='ë‚˜ì´ (ì„¸)'),
        y=alt.Y('ìì‚°', title='ìˆœìì‚° (ë§Œì›)'),
        tooltip=['ë‚˜ì´', alt.Tooltip('ìì‚°', format=',.0f')]
    ).properties(height=400)
    
    st.altair_chart(chart, use_container_width=True)
    
    # AI ì½”ë©˜íŠ¸ ë°•ìŠ¤
    st.subheader("ğŸ¤– AI ì¬ë¬´ ì§„ë‹¨")
    if final_asset > 0:
        st.markdown(f"""
        <div class="custom-box box-success">
            <b>âœ… í›Œë¥­í•©ë‹ˆë‹¤! íƒ„íƒ„í•œ ë…¸í›„ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.</b><br><br>
            í˜„ì¬ ì €ì¶• ìŠµê´€ê³¼ íˆ¬ì ìˆ˜ìµë¥ ({invest_rate}%)ì´ ìœ ì§€ëœë‹¤ë©´, {retire_age}ì„¸ ì€í‡´ í›„ì—ë„ ìì‚°ì´ ê³ ê°ˆë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            90ì„¸ ì‹œì ì—ë„ ì•½ <b>{final_asset:,.0f}ë§Œì›</b>ì˜ ìì‚°ì´ ë‚¨ì•„ìˆì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒë©ë‹ˆë‹¤.
            ì´ì œëŠ” ìì‚°ì„ ì§€í‚¤ëŠ” 'ì ˆì„¸ ì „ëµ'ì— ì§‘ì¤‘í•´ë³´ì„¸ìš”.
        </div>
        """, unsafe_allow_html=True)
    else:
        st.markdown(f"""
        <div class="custom-box box-warning">
            <b>âš ï¸ ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤! ìì‚° ê³ ê°ˆ ìœ„í—˜ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.</b><br><br>
            ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼, ê¸°ëŒ€ ìˆ˜ëª… ì´ì „ì— ìê¸ˆì´ ë¶€ì¡±í•´ì§ˆ í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤.
            <br>1. <b>ì€í‡´ ì‹œê¸°</b>ë¥¼ {retire_age + 3}ì„¸ ì •ë„ë¡œ ëŠ¦ì¶”ê±°ë‚˜
            <br>2. <b>ì›” ì €ì¶•ì•¡</b>ì„ {monthly_save + 50}ë§Œì› ì´ìƒìœ¼ë¡œ ëŠ˜ë¦¬ëŠ” ê²ƒì„ ê°•ë ¥íˆ ê¶Œì¥í•©ë‹ˆë‹¤.
        </div>
        """, unsafe_allow_html=True)

# [Tab 2] ë¶€ë™ì‚° ë¶„ì„
with tab2:
    if buy_house:
        col_r1, col_r2 = st.columns([1, 1])
        with col_r1:
            st.info(f"ğŸ“ **ë§¤ìˆ˜ ëª©í‘œ:** {house_price/10000}ì–µ ì•„íŒŒíŠ¸")
            st.write(f"- ë§¤ìˆ˜ ì‹œê¸°: **{buy_age}ì„¸**")
            st.write(f"- í•„ìš” ìê¸°ìë³¸: **{(house_price * (100-loan_ratio)/100):,.0f} ë§Œì›**")
            st.write(f"- ì˜ˆìƒ ëŒ€ì¶œê¸ˆ: **{(house_price * loan_ratio/100):,.0f} ë§Œì›**")
            
        with col_r2:
            tax = house_price * 0.011
            monthly_interest = (house_price * loan_ratio/100) * (loan_rate/100) / 12
            st.warning("âš ï¸ **ë§¤ìˆ˜ ì‹œ ê³ ë ¤í•  ìˆ¨ì€ ë¹„ìš©**")
            st.write(f"- ì˜ˆìƒ ì·¨ë“ì„¸ ë“±: ì•½ **{tax:,.0f} ë§Œì›**")
            st.write(f"- ì›” ëŒ€ì¶œ ì´ì: ì•½ **{monthly_interest:,.0f} ë§Œì›**")
            
        st.caption("â€» ì·¨ë“ì„¸ëŠ” 1ì£¼íƒì ê¸°ì¤€ 1.1%~3.5%ë¡œ ë‹¨ìˆœí™”í•˜ì—¬ ê³„ì‚°í–ˆìŠµë‹ˆë‹¤.")
    else:
        st.info("ë¶€ë™ì‚° ë§¤ìˆ˜ ê³„íšì´ ì²´í¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì‚¬ì´ë“œë°”ì—ì„œ 'ë‚´ ì§‘ ë§ˆë ¨ ê³„íš ìˆìŒ'ì„ ì²´í¬í•´ë³´ì„¸ìš”.")

# [Tab 3] ìƒì„¸ ë¦¬í¬íŠ¸
with tab3:
    st.write("ğŸ“Š ì—°ë„ë³„ ìì‚° ë³€í™” ìƒì„¸ í‘œ")
    st.dataframe(
        df_result.style.format({"ìì‚°": "{:,.0f}"}),
        use_container_width=True,
        height=400
    )
    
    if events:
        st.write("ğŸš© **ì£¼ìš” ë¼ì´í”„ ì´ë²¤íŠ¸**")
        for e in events:
            icon = "âœ…" if e['ìœ í˜•'] == "ì„±ê³µ" else "âŒ"
            st.write(f"{icon} **{e['ë‚˜ì´']}ì„¸:** {e['ì´ë²¤íŠ¸']}")
